<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    
    <title>Use appsettings.json and environment overrides in classic ASP.NET apps &#8211; Martin Ullrich</title>
    <meta name="description" content="Supercharge your classic ASP.NET apps with the config system introduced in ASP.NET Core">
    <meta name="keywords" content="asp.net-core asp.net configuration">
    
    <!-- Twitter Cards -->
    <meta name="twitter:card" content="summary">
    <meta name="twitter:site" content="@dasmulli">
    <meta name="twitter:creator" content="@dasmulli">
    
    <!-- Open Graph -->
    <meta name="og:locale" content="en_US">
    <meta name="og:type" content="article">
    <meta name="og:title" content="Use appsettings.json and environment overrides in classic ASP.NET apps">
    <meta name="og:description" content="Supercharge your classic ASP.NET apps with the config system introduced in ASP.NET Core">
    <meta name="og:url" content="http://dasmulli.blog/2017/01/21/use-appsettings-json-and-environment-overrides-in-classic-asp-net-apps">
    <meta name="og:site_name" content="Martin Ullrich">
    <meta name="og:image" content="http://dasmulli.blog/images/">
    
    <!-- TODO: Canonical URL -->
    
    <!-- Stylesheets -->
    <link rel="stylesheet" href="http://dasmulli.blog/stylesheets/vendor/font-awesome/font-awesome.css">
    <link rel="stylesheet" href="http://dasmulli.blog/stylesheets/vendor/prism-vs.css">
    <link rel="stylesheet" href="http://dasmulli.blog/stylesheets/main.css">
    <!-- Webfonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto">
    
    <link rel="shortcut icon" href="http://dasmulli.blog/favicon.ico">
    <link rel="shortcut icon" type="image/png" href="http://dasmulli.blog/favicon.png">
    
    <style>
      body {
        background-image: url(http://dasmulli.blog/images/triangular.png);
      }
    </style>
  </head>
  <body id="post" >
    <div class="header-menu header-menu-top">
      <ul class="header-item-container">
        <li class="header-item-title header-toggle">
          <a href="#menu"><h2><i class="fa fa-bars"></i></h2></a>
        </li>
        <li class="header-item-title">
          <a href="http://dasmulli.blog/">
            <img src="http://www.gravatar.com/avatar/1acd8ef9d33b72c888c544378a59be2b?s=70" alt="Martin A. Ullrich" class="author-logo logo">
            <span class="title">Martin Ullrich</span>
          </a>
        </li>
        <li class="header-item">
          <a href="http://dasmulli.blog/about">
            <h3>About</h3>
          </a>
        </li>
            <li class="header-item">
          <a href="http://dasmulli.blog/posts">
            <h3>Archive</h3>
          </a>
        </li>
            <li class="header-item">
          <a href="http://dasmulli.blog/">
            <h3>Home</h3>
          </a>
        </li>
            <li class="header-item">
          <a href="http://dasmulli.blog/search">
            <h3><i class="fa fa-search"></i></h3>
          </a>
        </li>
      </ul>
    </div>
    <div class="entry-header">
      <div class="header-title">
        <div class="header-title-wrap">
          <h1>Use appsettings.json and environment overrides in classic ASP.NET apps</h1>
          <h2>
            <span class="entry-date date published updated">
              <time datetime="2017-01-21T01:00:00+01:00">January 21, 2017</time>
            </span>
          </h2>
          <p class="entry-reading-time">
            <i class="fa fa-clock-o"></i>
            Reading time ~7 minutes
          </p>
        </div>
      </div>
    </div>

    <div id="main" role="main">
      <article class="entry">
        <div class="entry-content">
          <h1 class="post-title entry-title">Use appsettings.json and environment overrides in classic ASP.NET apps</h1>
          <p>I have come to appreciate <code>appsettings.json</code> and the environment-specifics overrides like <code>appsettings.Development.json</code>/<code>appsettings.Production.json</code>.
They are easy to use, can be live edited without needing to restart the application and most importantly,
you can <strong>build once and run the same output in multiple environments</strong>.</p>
<p>In classic ASP.NET web apps, we have <code>Web.config</code> and then a number of transformation files like <code>Web.Release.config</code>. These configs are hard to maintain - I end up googling the XDT syntax every time. And then I somehow need to apply the transformation multiple times - once for each environment. This means publishing multiple times or using other build techniques to accomplish the same.</p>
<p>Of course there are alternatives like custom tokenization for Web.config. But the main problem remains: We need to maintain logic that makes sure that the right Web.config with the right values ends up on the server.</p>
<p>This is a pain. Even more pain when we want to switch between these values in development. E.g. use a local database for development, but also be able to switch to the internal dev-test environment to debug an integration issue.</p>
<p>The SlowCheetah Visual Studio extension helps a lot for this, but has other complexity issues to set up and build. There&#x2019;s really no way around modifying the <code>Web.config</code> content even during development.</p>
<p>But the release of .NET Framework 4.7.1 now introduced a feature that changes everything.</p>
<h2>Say hello to ConfigurationBuilder</h2>
<p>In 4.7.1, you can create subclasses of <a href="https://docs.microsoft.com/en-us/dotnet/api/system.configuration.configurationbuilder?view=netframework-4.7.1"><code>System.Configuration.ConfigurationBuilder</code></a> to hook into the configuration loading process.</p>
<p><code>ConfigurationBuilder</code> allows you to modify the raw XML of any configuration section loaded from <code>Web.config</code> and/or modify the instantiated configuration section object before it is locked and passed on to the application for consumption. This means we can pull configuration from other sources transparently without needing to change anything else in the application. And of course this works for non-web applications (<code>App.config</code>) as well.</p>
<h2>Plugging the ASP.NET Core config system into ASP.NET</h2>
<p>Since the configuration system that ASP.NET Core uses is built for .NET Standard 2.0, we can use it on .NET Framework as well. This means we can use the same configuration sources available in ASP.NET Core as a source for a custom configuration builder.</p>
<p>We can even <strong>use config reloading</strong> to update AppSettings values on the fly without the need to restart the AppPool, which would mean a short downtime. Note that this does not work for connections strings, since they are read-only and shouldn&#x2019;t be changed at runtime.</p>
<h3>Step 1: Load the config</h3>
<p>Let&#x2019;s create the ConfigurationBuilder subclass, named <code>AppSettingsJsonConfigurationBuilder</code>:</p>
<pre class="language-csharp line-numbers"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">AppSettingsJsonConfigurationBuilder</span> <span class="token punctuation">:</span> ConfigurationBuilder
<span class="token punctuation">{</span>
<span class="token preprocessor property">#<span class="token directive keyword">if</span> DEBUG</span>
    <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token keyword">string</span> DefaultEnvironmentName <span class="token operator">=</span> <span class="token string">&quot;Development&quot;</span><span class="token punctuation">;</span>
<span class="token preprocessor property">#<span class="token directive keyword">else</span></span>
    <span class="token keyword">private</span> <span class="token keyword">const</span> <span class="token keyword">string</span> DefaultEnvironmentName <span class="token operator">=</span> <span class="token string">&quot;Production&quot;</span><span class="token punctuation">;</span>
<span class="token preprocessor property">#<span class="token directive keyword">endif</span></span>

    <span class="token keyword">private</span> <span class="token keyword">readonly</span> Lazy<span class="token operator">&lt;</span>IConfigurationRoot<span class="token operator">&gt;</span> Configuration <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Lazy</span><span class="token operator">&lt;</span>IConfigurationRoot<span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> environmentName <span class="token operator">=</span> Environment<span class="token punctuation">.</span><span class="token function">GetEnvironmentVariable</span><span class="token punctuation">(</span><span class="token string">&quot;ASPNET_ENVIRONMENT&quot;</span><span class="token punctuation">)</span> <span class="token operator">?</span><span class="token operator">?</span>
                                Environment<span class="token punctuation">.</span><span class="token function">GetEnvironmentVariable</span><span class="token punctuation">(</span><span class="token string">&quot;ASPNETCORE_ENVIRONMENT&quot;</span><span class="token punctuation">)</span> <span class="token operator">?</span><span class="token operator">?</span>
                                DefaultEnvironmentName<span class="token punctuation">;</span>

        <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Microsoft<span class="token punctuation">.</span>Extensions<span class="token punctuation">.</span>Configuration<span class="token punctuation">.</span>ConfigurationBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">AddJsonFile</span><span class="token punctuation">(</span><span class="token string">&quot;appsettings.json&quot;</span><span class="token punctuation">,</span> optional<span class="token punctuation">:</span> <span class="token keyword">false</span><span class="token punctuation">,</span> reloadOnChange<span class="token punctuation">:</span> <span class="token keyword">true</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">AddJsonFile</span><span class="token punctuation">(</span>$<span class="token string">&quot;appsettings.{environmentName}.json&quot;</span><span class="token punctuation">,</span> optional<span class="token punctuation">:</span> <span class="token keyword">true</span><span class="token punctuation">,</span> reloadOnChange<span class="token punctuation">:</span> <span class="token keyword">true</span><span class="token punctuation">)</span>
            <span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>This part defines how the configuratin is loaded. I want to use the <code>Development</code> environment as default when in debug mode, which is what I will be doing in Visual Studio over 90% of the time. Otherwise, use <code>Production</code>. This code also allows to set environment variables on the server or IIS App Pool to select the current environment. For compatibility, <code>ASPNETCORE_ENVIRONMENT</code> is also used so we only need to set one variable should we already be running ASP.NET Core apps on the same system.</p>
<p>The <code>Lazy&lt;T&gt;</code> instance is just a fancy way to load the config files on first use only.</p>
<p>When accessed, the code loads a required <code>appsettings.json</code> file and an optional override json file for the current environment. by specifying <code>reloadOnChange: true</code>, we can later register for changes to the configuraitons.</p>
<h3>Step 2: Process configuration sections.</h3>
<p>There are two methos we can override on <code>ConfigurationBuilder</code>:</p>
<pre class="language-csharp line-numbers"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">ConfigurationBuilder</span> <span class="token punctuation">:</span> ProviderBase
<span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">virtual</span> XmlNode <span class="token function">ProcessRawXml</span><span class="token punctuation">(</span>XmlNode rawXml<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> rawXml<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">virtual</span> ConfigurationSection <span class="token function">ProcessConfigurationSection</span><span class="token punctuation">(</span>ConfigurationSection configSection<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> configSection<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Modifying the XML content is useful for configuration sections that don&#x2019;t provide easy to use editing APIs. For our purposes, we  only need to override the <code>ProcessConfigurationSection</code> method.</p>
<p>So let&#x2019;s override the method and foward to more specific methods for the app settings and connection strings sections (thankfully, c# 7 pattern matching makes this quite easy):</p>
<pre class="language-csharp line-numbers"><code class="language-csharp"><span class="token keyword">public</span> <span class="token keyword">override</span> ConfigurationSection <span class="token function">ProcessConfigurationSection</span><span class="token punctuation">(</span>ConfigurationSection configSection<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>configSection<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">case</span> AppSettingsSection appSettingsSection<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token function">ProcessAppSettingsSection</span><span class="token punctuation">(</span>appSettingsSection<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">case</span> ConnectionStringsSection connectionStringsSection<span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token function">ProcessConnectionStringsSection</span><span class="token punctuation">(</span>connectionStringsSection<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">default</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> <span class="token keyword">base</span><span class="token punctuation">.</span><span class="token function">ProcessConfigurationSection</span><span class="token punctuation">(</span>configSection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3>Step 3: Fill app settings</h3>
<p>The json for the app settings should be a &#x201C;section&#x201D; (both .NET Framework config and the Microsoft.Extensions config use the same naming here) of key-value pairs like so:</p>
<pre class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>
    <span class="token property">&quot;AppSettings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">&quot;Key&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Value&quot;</span><span class="token punctuation">,</span>
        &#x2026;
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>This code is used to pull the app settings out of the json config and performan add-or-update on the .NET Framework app settings configuration section:</p>
<pre class="language-csharp line-numbers"><code class="language-csharp"><span class="token keyword">private</span> AppSettingsSection <span class="token function">ProcessAppSettingsSection</span><span class="token punctuation">(</span>AppSettingsSection section<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">var</span> appSettingsConfigSection <span class="token operator">=</span> Configuration<span class="token punctuation">.</span>Value<span class="token punctuation">.</span><span class="token function">GetSection</span><span class="token punctuation">(</span><span class="token string">&quot;AppSettings&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>appSettingsConfigSection <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> section<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token keyword">var</span> setting <span class="token keyword">in</span> appSettingsConfigSection<span class="token punctuation">.</span><span class="token function">GetChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// keys that contain subsections have a null value</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>setting<span class="token punctuation">.</span>Value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>section<span class="token punctuation">.</span>Settings<span class="token punctuation">[</span>setting<span class="token punctuation">.</span>Key<span class="token punctuation">]</span> <span class="token keyword">is</span> KeyValueConfigurationElement existingElement<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            existingElement<span class="token punctuation">.</span>Value <span class="token operator">=</span> setting<span class="token punctuation">.</span>Value<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            section<span class="token punctuation">.</span>Settings<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>setting<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> setting<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> section<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3>Step 4: Load connection strings</h3>
<p>The same needs to be done for connection strings.
This time however we want to accomodate for both simple strings as connection strings and objects specifying both the connection string and the provider name.</p>
<pre class="language-csharp line-numbers"><code class="language-csharp"><span class="token keyword">private</span> ConnectionStringsSection <span class="token function">ProcessConnectionStringsSection</span><span class="token punctuation">(</span>ConnectionStringsSection section<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token keyword">var</span> connectionStringsSection <span class="token operator">=</span> Configuration<span class="token punctuation">.</span>Value<span class="token punctuation">.</span><span class="token function">GetSection</span><span class="token punctuation">(</span><span class="token string">&quot;ConnectionStrings&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>connectionStringsSection <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">return</span> section<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">var</span> connectionStringSettingsCollection <span class="token operator">=</span> section<span class="token punctuation">.</span>ConnectionStrings<span class="token punctuation">;</span>

    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token keyword">var</span> setting <span class="token keyword">in</span> connectionStringsSection<span class="token punctuation">.</span><span class="token function">GetChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> key <span class="token operator">=</span> setting<span class="token punctuation">.</span>Key<span class="token punctuation">;</span>
        <span class="token keyword">string</span> <span class="token keyword">value</span><span class="token punctuation">;</span>
        <span class="token keyword">string</span> providerName <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">// keys that contain subsections have a null value</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>setting<span class="token punctuation">.</span>Value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">value</span> <span class="token operator">=</span> setting<span class="token punctuation">[</span><span class="token string">&quot;ConnectionString&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            providerName <span class="token operator">=</span> setting<span class="token punctuation">[</span><span class="token string">&quot;ProviderName&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">value</span> <span class="token operator">=</span> setting<span class="token punctuation">.</span>Value<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">value</span> <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">continue</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>connectionStringSettingsCollection<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token keyword">is</span> ConnectionStringSettings existingConnectionString<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            existingConnectionString<span class="token punctuation">.</span>ConnectionString <span class="token operator">=</span> <span class="token keyword">value</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>providerName <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                existingConnectionString<span class="token punctuation">.</span>ProviderName <span class="token operator">=</span> providerName<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">else</span>
        <span class="token punctuation">{</span>
            connectionStringSettingsCollection<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>providerName <span class="token operator">!=</span> <span class="token keyword">null</span>
                <span class="token operator">?</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionStringSettings</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">value</span><span class="token punctuation">,</span> providerName<span class="token punctuation">)</span>
                <span class="token punctuation">:</span> <span class="token keyword">new</span> <span class="token class-name">ConnectionStringSettings</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> section<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h3>Step 5: Reload app settings on changes</h3>
<p>Since app settings can be modified during runtime, we can use the Microsoft.Extension.Configuration system&#x2019;s reload functionality to register for changes.</p>
<p>This works by requesting a reload token and registering a change callback. The callback is only called once, so we need to reregister on every change.</p>
<p>To do this, we extend the <code>ProcessAppSettingsSection</code> from step 3 to register for the first change, use the <code>ConfigurationManager</code> api to modify app settings on change and re-register for further changes:</p>
<pre class="language-csharp line-numbers"><code class="language-csharp">    <span class="token keyword">private</span> AppSettingsSection <span class="token function">ProcessAppSettingsSection</span><span class="token punctuation">(</span>AppSettingsSection section<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">// omitted. see step 3</span>

        appSettingsConfigSection<span class="token punctuation">.</span><span class="token function">GetReloadToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RegisterChangeCallback</span><span class="token punctuation">(</span>AppSettingsSectionChanged<span class="token punctuation">,</span> appSettingsConfigSection<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> section<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">AppSettingsSectionChanged</span><span class="token punctuation">(</span><span class="token keyword">object</span> configSectionObj<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">var</span> configSection <span class="token operator">=</span> <span class="token punctuation">(</span>IConfigurationSection<span class="token punctuation">)</span>configSectionObj<span class="token punctuation">;</span>
        <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token keyword">var</span> setting <span class="token keyword">in</span> configSection<span class="token punctuation">.</span><span class="token function">GetChildren</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>setting<span class="token punctuation">.</span>Value <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            ConfigurationManager<span class="token punctuation">.</span>AppSettings<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span>setting<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> setting<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        configSection<span class="token punctuation">.</span><span class="token function">GetReloadToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">RegisterChangeCallback</span><span class="token punctuation">(</span>AppSettingsSectionChanged<span class="token punctuation">,</span> configSection<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre>
<h3>Step 6: Register the custom configuration builder in <code>Web.config</code></h3>
<p>Finally, we need to tell .NET Framework to use our shiny new confiugration builder. To do this, we need to modify the <code>Web.config</code> to add the following:</p>
<pre class="language-xml line-numbers"><code class="language-xml"><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configSections</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>section</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>configBuilders<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>System.Configuration.ConfigurationBuildersSection, System.Configuration, Version=4.0.0.0, Culture=neutral, PublicKeyToken=b03f5f7f11d50a3a<span class="token punctuation">&quot;</span></span> <span class="token attr-name">restartOnExternalChanges</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>false<span class="token punctuation">&quot;</span></span> <span class="token attr-name">requirePermission</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>false<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configSections</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>configBuilders</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>builders</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>add</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>AppSettingsJsonConfigurationBuilder<span class="token punctuation">&quot;</span></span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>ConfigSampleWebApp.AppSettingsJsonConfigurationBuilder, ConfigSampleWebApp<span class="token punctuation">&quot;</span></span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>builders</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>configBuilders</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>appSettings</span> <span class="token attr-name">configBuilders</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>AppSettingsJsonConfigurationBuilder<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>appSettings</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>connectionStrings</span> <span class="token attr-name">configBuilders</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>AppSettingsJsonConfigurationBuilder<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>clear</span><span class="token punctuation">/&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>connectionStrings</span><span class="token punctuation">&gt;</span></span>
</code></pre>
<h2>Putting it all together</h2>
<p>For the sample app, the config files I used are:</p>
<p><code>appsettings.json</code>:</p>
<pre class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">&quot;AppSettings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;MySetting1&quot;</span><span class="token operator">:</span> <span class="token string">&quot;MyValue1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;MySetting2&quot;</span><span class="token operator">:</span> <span class="token string">&quot;MyValue2&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;ConnectionStrings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;MyConnection&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Data Source=(LocalDB);AttachDbFileName=|DataDirectory|\\DatabaseFileName.mdf;InitialCatalog=DatabaseName;Integrated Security=True;MultipleActiveResultSets=True&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;MyOtherConnection&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;ConnectionString&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Data Source=(LocalDB);AttachDbFileName=|DataDirectory|\\OtherDatabaseFileName.mdf;InitialCatalog=DatabaseName;Integrated Security=True;MultipleActiveResultSets=True&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;ProviderName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;System.Data.SqlClient&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p><code>appsettings.Development.json</code>:</p>
<pre class="language-json line-numbers"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">&quot;AppSettings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;MySetting1&quot;</span><span class="token operator">:</span> <span class="token string">&quot;MyDevelopmentValue1&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;MyDevOnlySetting&quot;</span><span class="token operator">:</span> <span class="token string">&quot;MyDevOnlyValue&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;ConnectionStrings&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;MyConnection&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Data Source=(LocalDB);AttachDbFileName=|DataDirectory|\\Development_DatabaseFileName.mdf;InitialCatalog=DatabaseName;Integrated Security=True;MultipleActiveResultSets=True&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;MyOtherConnection&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">&quot;ConnectionString&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Data Source=(LocalDB);AttachDbFileName=|DataDirectory|\\Development_OtherDatabaseFileName.mdf;InitialCatalog=DatabaseName;Integrated Security=True;MultipleActiveResultSets=True&quot;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Then i created a <code>Default.aspx</code> site that uses <code>ConfigurationManager</code> to list all app settings and connection strings. The result is:</p>
<p><img src="2018-02-configbuilder-result.png" alt="result"></p>
<p>This means i can now create more <code>appsettings.*.json</code> files and use the same build output for all environments, just setting different environment variables on the machines or App Pools.</p>
<h1>Sample App</h1>
<p>The sample app is hosted on GitHub at <a href="https://github.com/dasMulli/ConfigSampleWebApp">dasMulli/ConfigSampleWebApp</a>.</p>
<h1>Note on security.</h1>
<p>Don&#x2019;t forget to prevent your json files from being downloaded!</p>

          <footer class="entry-meta">
            <!-- TODO: Tags -->
            <span class="author vcard"><span class="fn">Martin A. Ullrich</span></span>
            <!-- TODO: Social Share -->
          </footer>
        </div>
        <div class="read-more">
          <div class="read-more-header">
            <a href="https://dasmulli.github.io" class="read-more-btn">About the Author</a>
          </div>
          <div class="read-more-content author-info">
            <h3>Martin A. Ullrich</h3>
            <div class="author-container">
              <img src="http://www.gravatar.com/avatar/1acd8ef9d33b72c888c544378a59be2b?s=150" alt="Martin A. Ullrich" class="author-img">
              <div class="author-bio">Software Developer in the .NET space. Also do Java, Swift/ObjC and front-end stuff.</div>
            </div>
            <div class="author-share">
              <ul class="list-inline social-buttons">
                <li>
                  <a href="https://github.com/dasmulli" title="GitHub" target="_blank">
                    <i class="fa fa-github-alt fa-fw"></i>
                  </a>
                </li>
                <li>
                  <a href="https://www.facebook.com/martin.andreas.ullrich" title="Facebook" target="_blank">
                    <i class="fa fa-facebook-official fa-fw"></i>
                  </a>
                </li>
                <li>
                  <a href="https://stackoverflow.com/users/784387/martin-ullrich" title="StackOverflow" target="_blank">
                    <i class="fa fa-stack-overflow fa-fw"></i>
                  </a>
                </li>
                <li>
                  <a href="https://twitter.com/dasmulli" title="Twitter" target="_blank">
                    <i class="fa fa-twitter fa-fw"></i>
                  </a>
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div class="read-more">
          <div class="read-more-header">
            <a href="http://dasmulli.blog/2017/01/20/make-dotnet-test-work-on-solution-files" class="read-more-btn">Read More</a>
          </div>
        </div>
      </article>
    </div>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
    
      ga('create', 'UA-112754157-1', 'auto');
      ga('require', 'linkid', 'linkid.js');
      ga('send', 'pageview');
    </script>
    

    <div class="footer-wrapper">
      <footer class="contentinfo">
        <span>&copy; 2018 Martin A. Ullrich. Powered by <a href="http://www.metalsmith.io/" rel="nofollow">Matalsmith</a> using the <a href="https://github.com/tjpeden/neo-hpstr-metalsmith-theme" rel="nofollow">Neo-HPSTR Metalsmith Theme</a>.</span>
      </footer>
    </div>
  </body>
</html>
